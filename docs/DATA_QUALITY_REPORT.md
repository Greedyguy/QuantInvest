# 📊 한국 시장 데이터 품질 점검 리포트

**점검 일시**: 2025-11-17  
**대상 데이터**: `data/enriched/`, `data/ohlcv/`

---

## 🎯 종합 평가: **46.4/100** (❌ 불량)

---

## 1️⃣ Universe 커버리지: **85.6/100** (✅ 양호)

### 현황
- **전체 한국 시장 종목**: 2,879개
  - KOSPI: 958개
  - KOSDAQ: 1,805개
  - KONEX: 116개

- **캐시된 종목**: 2,465개
  - 커버리지: **85.6%**
  - 누락 종목: 414개

- **파일 통계**:
  - Enriched 파일: 12,311개
  - 평균 파일 크기: 0.13 MB
  - 총 캐시 크기: **1,569 MB** (~1.5GB)

### 평가
✅ **양호**: 대부분의 종목이 캐시됨  
⚠️  14.4%의 종목 누락 (신규 상장, 관리종목, ETF 등으로 추정)

---

## 2️⃣ 데이터 완전성: **0.0/100** (❌ 심각)

### 현황
**샘플 100개 종목 테스트 결과**:
- **로드 실패**: 100/100 (100%)
- 로드 성공: 0개

### 오류 원인
```
⚠️  185750 enriched 로드 실패: unsupported operand type(s) for -: 'NoneType' and 'Timestamp'
```

**분석**:
- `cache_manager.py`의 `load_enriched()` 함수에서 오류 발생
- `None` 값과 `Timestamp` 연산 시도
- 날짜 범위 검증 로직의 버그로 추정

### 영향
❌ **심각**: 캐시된 데이터를 전혀 로드할 수 없음  
→ 백테스트 실행 시마다 pykrx에서 새로 다운로드해야 함  
→ **데이터 재현성 문제** 발생

---

## 3️⃣ 지표 계산: **0.0/100** (❌ 심각)

### 현황
- OHLCV 데이터: 0/100 확인됨
- Volume 데이터: 0/100 확인됨
- 지표 데이터: 0/100 확인됨

### 원인
데이터 로드 자체가 실패하여 지표 계산 여부 확인 불가

---

## 4️⃣ 시가총액 데이터: **0.0/100** (❌ 심각)

### 현황
- 시가총액 데이터 보유: **0/50** (0.0%)
- 거의 모든 enriched 데이터에 `market_cap` 컬럼 없음

### 영향
❌ KSMS와 같은 소형주 전략에서 **시가총액 필터링 불가**  
⚠️  Universe 필터링 정확도 저하

---

## 5️⃣ 시계열 연속성: **100.0/100** (✅ 우수)

### 현황
- 날짜 갭 발견: 0개
- 거래일 기준 연속성 양호

---

## 🔴 심각한 문제점

### 1. `load_enriched` 함수 버그
**위치**: `cache_manager.py`

**문제**:
```python
# 날짜 범위 검증 시 None 처리 미흡
if df_end is None:
    # 오류 발생!
    days_old = (req_end - df_end).days  # ← TypeError!
```

**해결 방안**:
```python
# None 체크 추가
if df_end is None or df_start is None:
    return None
```

---

### 2. 시가총액 데이터 누락
**원인**: `data_loader.py`에서 시가총액 수집 로직 없음

**해결 방안**:
```python
# pykrx에서 시가총액 추가
df["market_cap"] = stock.get_market_cap(ticker, start, end)
```

---

### 3. 데이터 중복 문제
**발견**: 같은 종목에 대해 여러 날짜 버전 파일 존재
```
000020_20190101_20251107.parquet
000020_20190101_20251110.parquet
000020_20190101_20251111.parquet
000020_20190101_20251112.parquet
000020_20190101_20251113.parquet
```

**영향**:
- 디스크 공간 낭비 (중복 데이터)
- 최신 파일 선택 로직 필요

---

## 💡 권장 조치사항

### 🔥 긴급 (High Priority)
1. ✅ **`cache_manager.py` `load_enriched()` 버그 수정**
   - None 체크 추가
   - 날짜 검증 로직 개선

2. ✅ **시가총액 데이터 수집 로직 추가**
   - `data_loader.py` 개선
   - pykrx `get_market_cap()` 활용

3. ✅ **데이터 로드 테스트**
   - 수정 후 샘플 데이터 로드 확인
   - 백테스트 정상 작동 검증

### ⚠️  중요 (Medium Priority)
4. **중복 파일 정리**
   - 각 종목당 최신 파일만 보관
   - 증분 업데이트 로직 개선

5. **누락 종목 수집**
   - 414개 누락 종목 재수집
   - Universe 커버리지 90% 이상 확보

### 📋 개선 (Low Priority)
6. **데이터 검증 자동화**
   - 일일 데이터 품질 체크
   - 이상치 탐지 및 알림

7. **백업 및 복구 체계**
   - 정기 백업
   - 데이터 손상 시 복구 절차

---

## 🚀 개선 후 기대 효과

### Before (현재)
- **종합 점수**: 46.4/100
- 데이터 로드: ❌ 실패
- 백테스트: ⚠️  매번 새로 다운로드
- 재현성: ❌ 없음
- 소형주 필터: ❌ 불가

### After (개선 후)
- **종합 점수**: 85+ /100 (예상)
- 데이터 로드: ✅ 정상
- 백테스트: ✅ 캐시 활용 (10배 빠름)
- 재현성: ✅ 보장
- 소형주 필터: ✅ 정확

---

## 📌 Next Steps

1. **즉시**: `cache_manager.py` 버그 수정
2. **오늘 내**: 시가총액 수집 로직 추가
3. **이번 주**: 데이터 품질 재점검
4. **다음 주**: 중복 파일 정리 및 자동화

---

**작성자**: Cursor AI Assistant  
**문의**: 추가 점검 필요 시 `python data_quality_check.py` 재실행

